<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Głosowanie</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<main>
  <h1>Głosowanie – Kto jest impostorem?</h1>
  <ul id="playersList"></ul>
  <div style="text-align:center;">
    <button id="voteBtn">VOTE</button>
    <p id="progressText">0 / 0 osób zagłosowało</p>
  </div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
const params = new URLSearchParams(location.search);
const lobbyId = params.get('lobby');
const name = params.get('name');

const socket = io();

const playersList = document.getElementById('playersList');
const voteBtn = document.getElementById('voteBtn');
const progressText = document.getElementById('progressText');

let selectedPlayer = null;
let hasVoted = false;

// Pobierz listę graczy z serwera
socket.emit('joinLobby', { lobbyId, name });

socket.on('players', (players) => {
  playersList.innerHTML = '';
  players.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p.name;
    li.classList.add('vote-option');
    li.addEventListener('click', () => {
      if (hasVoted) return;
      document.querySelectorAll('.vote-option').forEach(el => el.classList.remove('selected'));
      li.classList.add('selected');
      selectedPlayer = p.name;
    });
    playersList.appendChild(li);
  });
});

voteBtn.addEventListener('click', () => {
  if (!selectedPlayer || hasVoted) return alert('Wybierz gracza!');
  hasVoted = true;
  voteBtn.disabled = true;
  socket.emit('voteImpostor', { lobbyId, target: selectedPlayer });
});

socket.on('voteProgress', ({ count, total }) => {
  progressText.textContent = `${count} / ${total} osób zagłosowało`;
});

socket.on('voteResult', (data) => {
  window.location.href = `/results.html?lobby=${lobbyId}&name=${encodeURIComponent(name)}&result=${data.result}&impostor=${encodeURIComponent(data.impostorName)}`;
});
</script>
</body>
</html>
